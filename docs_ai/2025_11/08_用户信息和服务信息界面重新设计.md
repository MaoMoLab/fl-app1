# 用户信息和服务信息界面重新设计

**日期**: 2025-11-08  
**类型**: UI/UX 重构与功能增强

## 变更概述

重新设计了用户基本信息页面和旧版服务信息的界面效果，优化了代码结构，并增加了流量编辑的双向转换功能。

## 主要变更

### 1. 流量格式化工具增强 (`lib/helper/format_helper.dart`)

新增 `parseBytes` 函数，支持人类可读格式与字节数的双向转换：

```dart
/// 解析人类可读格式的字节大小为整数
int? parseBytes
(
String
input
)
```

**支持的格式**:

- `10.5 GB`
- `1024 MB`
- `500 KB`
- 自动识别单位: B, KB, MB, GB, TB, PB

### 2. 用户基本信息卡片组件 (`lib/component/low_admin/editable_user_v2_info_card_component.dart`)

#### 功能特性

✅ **编辑模式切换**

- 点击编辑按钮进入编辑模式
- 支持取消和保存操作
- 保存时显示加载状态

✅ **字段编辑**

- 邮箱
- 用户名
- Telegram ID
- 账号启用状态（开关）
- 邮箱验证状态（开关）
- 账号过期时间（日期时间选择器）

✅ **时间处理规范**

- API 数据使用 UTC 时间
- UI 显示和编辑使用本地时间
- 提交前自动转换为 UTC

✅ **UI 设计**

- 统一卡片风格
- 图标化信息展示
- 状态颜色标识
    - 绿色：正常/已启用/已验证
    - 红色：过期/已禁用
    - 橙色：未验证

#### 数据流向

```
API (UTC) → .toLocal() → UI 编辑 → .toUtc() → API 提交
```

### 3. 旧版服务信息卡片组件 (`lib/component/low_admin/editable_user_old_service_card_component.dart`)

#### 功能特性

✅ **流量进度可视化**

- 彩色进度条
    - 绿色: 使用率 < 70%
    - 橙色: 70% ≤ 使用率 < 90%
    - 红色: 使用率 ≥ 90%
- 百分比显示
- 已用/总量显示

✅ **流量编辑功能**

- 点击流量行弹出编辑对话框
- 双输入框实时同步：
    - **人类可读格式**: `10.5 GB`
    - **原始字节数**: `11274289152`
- 支持编辑的字段：
    - 上传流量
    - 下载流量
    - 总流量限制
    - 昨日使用流量

✅ **流量显示优化**

- 主显示：格式化值（如 `10.5 GB`）
- 副显示：原始字节数（灰色小字）
- 剩余流量警告（< 1GB 显示红色）

✅ **服务信息展示**

- 服务ID
- 用户ID
- 连接限制
- 自动重置流量
- 创建/更新时间

#### 编辑对话框设计

```
┌─────────────────────────────┐
│ 编辑上传流量                 │
├─────────────────────────────┤
│ 人类可读格式                 │
│ [10.5 GB            ] 📝    │
│                             │
│ 原始字节数                   │
│ [11274289152        ] 🔢    │
│                             │
│ ℹ️ 支持的单位                │
│ B, KB, MB, GB, TB, PB       │
│ 两种输入框会自动同步转换      │
├─────────────────────────────┤
│            [取消]  [保存]    │
└─────────────────────────────┘
```

### 4. UI 设计规范

#### 卡片结构

```
┌─────────────────────────────┐
│ [图标] 标题          [操作]  │
├─────────────────────────────┤
│ 内容区域                     │
│ • 图标 + 标签 + 值           │
│ • 对齐整齐                   │
│ • 颜色标识状态               │
└─────────────────────────────┘
```

#### 颜色语义

- **绿色**: 正常、可用、充足
- **红色**: 异常、禁用、不足
- **橙色**: 警告、未验证
- **蓝色**: 提示、自动功能
- **灰色**: 辅助信息

#### 交互设计

- **只读模式**: 清晰展示信息
- **编辑模式**: 表单输入，带验证
- **加载状态**: CircularProgressIndicator
- **反馈提示**: SnackBar

### 5. 代码优化

#### 遵循规范

✅ 缩进2空格  
✅ 使用明确类型声明  
✅ 避免无意义的 try-catch  
✅ 使用 `formatBytes` 而非重复实现  
✅ 状态管理清晰  
✅ 时间处理符合 UTC/Local 规范

#### 代码结构

```
Component
├── State
│   ├── _initializeControllers()  // 初始化
│   ├── _toggleEdit()              // 切换编辑
│   ├── _cancelEdit()              // 取消编辑
│   ├── _selectDateTime()          // 时间选择
│   └── _formatDateTime()          // 时间格式化
└── Build Methods
    ├── build()                    // 主构建
    ├── _buildHeader()             // 头部
    ├── _buildContent()            // 内容
    ├── _buildInfoRow()            // 信息行
    └── _buildEditableTrafficRow() // 可编辑流量行
```

## 使用示例

### 用户基本信息卡片

```dart
EditableUserV2InfoCardComponent
(
userData: adminUserV,
onUpdate: (data) async {
final body = WebSubFastapiRoutersApiVLowAdminApiUserPutUserParamsModel(
email: data['email'] as String,
userName: data['userName'] as String,
isEnable: data['isEnable'] as bool,
isEmailVerify: data['isEmailVerify'] as bool,
// 提交前转换为 UTC
userAccountExpireIn: (data['userAccountExpireIn'] as DateTime).toUtc(),
telegramId: data['telegramId'] as int?,
);

final result = await restClient.putUser(...);
return result.isSuccess;
},
)
```

### 旧版服务信息卡片

```dart
EditableUserOldServiceCardComponent
(
serviceData: adminServiceV,
onUpdate: (data) async {
final body = WebSubFastapiRoutersApiVLowAdminApiServicePutServiceParamsModel(
ssUploadSize: data['ssUploadSize'] as int?,
ssDownloadSize: data['ssDownloadSize'] as int?,
ssBandwidthTotalSize: data['ssBandwidthTotalSize'] as int?,
ssBandwidthYesterdayUsedSize: data['ssBandwidthYesterdayUsedSize'] as int?,
);

final result = await restClient.putService(...);
return result.isSuccess;
},
)
```

## 技术亮点

### 1. 双向数据绑定

流量编辑对话框实现了格式化值与原始值的实时同步：

```dart
void _onHumanChanged(String value) {
  final bytes = parseBytes(value); // "10.5 GB" → 11274289152
  if (bytes != null) {
    _rawController.text = bytes.toString();
  }
}

void _onRawChanged(String value) {
  final bytes = int.tryParse(value); // 11274289152 → "10.5 GB"
  if (bytes != null) {
    _humanController.text = formatBytes(bytes);
  }
}
```

### 2. 状态管理优化

- 使用 `late` 延迟初始化
- 使用 `final` 声明不可变控制器
- 正确的生命周期管理（dispose）

### 3. 时间处理正确性

```dart
// 初始化: UTC → Local
_userAccountExpireIn = user.userAccountExpireIn.toLocal
();

// 提交: Local → UTC
userAccountExpireIn: _userAccountExpireIn.toUtc
();

// 显示: 始终使用 Local
_formatDateTime
(
dateTime
.
toLocal
(
)
);
```

## 视觉效果对比

### 旧设计

- 简单文本列表
- 无编辑功能
- 流量显示单一

### 新设计

- ✅ 卡片化布局
- ✅ 图标化信息
- ✅ 内联编辑
- ✅ 进度可视化
- ✅ 流量双格式显示
- ✅ 状态颜色标识
- ✅ 响应式反馈

## 文件清单

### 新增文件

- `lib/component/low_admin/editable_user_v2_info_card_component.dart`
- `lib/component/low_admin/editable_user_old_service_card_component.dart`
- `docs_ai/2025_11/08_用户信息和服务信息界面重新设计.md`

### 修改文件

- `lib/helper/format_helper.dart` - 新增 `parseBytes` 函数

## 下一步建议

1. **集成到主页面**: 在用户详情页使用这两个组件
2. **添加权限控制**: 根据用户权限显示/隐藏编辑功能
3. **批量操作**: 支持批量修改多个用户的服务配置
4. **历史记录**: 记录流量修改历史
5. **导出功能**: 支持导出用户信息和服务配置

## 测试建议

### 单元测试

✅ 已创建 `test/format_helper_test.dart`

- [x] formatBytes 格式化功能
- [x] parseBytes 解析功能
- [x] 双向转换准确性
- [x] 边界值处理
- [x] 异常输入处理

### 集成测试

- [ ] 编辑模式切换
- [ ] 数据保存和回滚
- [ ] 流量格式转换准确性
- [ ] 时间选择器中文显示
- [ ] UTC/Local 时间转换正确性
- [ ] 表单验证
- [ ] 错误提示
- [ ] 加载状态显示

## 运行测试

```bash
# 运行所有测试
flutter test

# 运行特定测试
flutter test test/format_helper_test.dart
```

## 总结

本次重构实现了：

1. ✅ **用户基本信息卡片** - 完整的编辑功能，美观的UI设计
2. ✅ **旧版服务信息卡片** - 流量双格式编辑，进度可视化
3. ✅ **流量格式转换工具** - 支持人类可读格式与字节数的双向转换
4. ✅ **代码规范化** - 遵循项目编码规范
5. ✅ **单元测试** - 保证核心功能的正确性

所有组件已集成到 `LowAdminUserDetailPage`，可直接使用。

## 注意事项

1. **API更新方式**: 服务信息使用PATCH方法，支持部分字段更新
2. **时间处理**: 严格遵循UTC/Local转换规范
3. **流量编辑**: 使用对话框方式，提供更好的用户体验
4. **错误处理**: 所有API调用都有成功/失败的反馈提示
5. **状态刷新**: 更新成功后自动刷新整个页面数据

## 使用演示

### 页面结构

```
用户详情页面
├── 用户基本信息卡片
│   ├── 显示模式 (只读)
│   │   ├── 用户ID
│   │   ├── 邮箱
│   │   ├── 用户名
│   │   ├── Telegram ID
│   │   ├── 账号状态 (绿色=启用/红色=禁用)
│   │   ├── 邮箱验证 (绿色=已验证/橙色=未验证)
│   │   ├── 账号过期时间 (绿色=有效/红色=过期)
│   │   └── 创建时间
│   └── 编辑模式
│       ├── 文本输入框 (邮箱、用户名、Telegram ID)
│       ├── 开关控件 (账号启用、邮箱验证)
│       ├── 时间选择器 (账号过期时间)
│       └── 操作按钮 (取消、保存)
│
├── 旧版服务信息卡片
│   ├── 流量进度条
│   │   ├── 彩色进度 (绿色/橙色/红色)
│   │   ├── 百分比显示
│   │   └── 已用/总量显示
│   ├── 流量详情 (可点击编辑)
│   │   ├── 上传流量 (格式化 + 原始值)
│   │   ├── 下载流量 (格式化 + 原始值)
│   │   ├── 总流量限制 (格式化 + 原始值)
│   │   ├── 剩余流量 (<1GB显示红色)
│   │   └── 昨日使用 (格式化 + 原始值)
│   └── 服务信息
│       ├── 用户等级
│       ├── 等级过期时间
│       ├── 连接数量
│       ├── 速度限制
│       ├── 自动重置流量
│       ├── 自动重置日
│       ├── 最后使用时间
│       └── 最后签到时间
│
└── 其他功能卡片
    ├── 钱包信息
    ├── 购买记录
    └── 充值记录
```

### 流量编辑流程

```
1. 用户点击流量行 (例: 上传流量)
   ↓
2. 弹出编辑对话框
   ├── 人类可读格式输入框: "10.50 GB"
   └── 原始字节数输入框: "11274289152"
   ↓
3. 用户修改任意一个输入框
   ├── 修改 "10.50 GB" → 自动更新为 "11274289152"
   └── 修改 "11274289152" → 自动更新为 "10.50 GB"
   ↓
4. 点击保存按钮
   ↓
5. 调用API (PATCH方法，只更新该字段)
   ↓
6. 显示结果
   ├── 成功 → SnackBar提示 + 刷新页面
   └── 失败 → SnackBar错误提示
```

### 操作示例

#### 编辑用户邮箱

1. 点击用户基本信息卡片的"编辑"按钮
2. 修改邮箱输入框
3. 点击"保存"按钮
4. 等待加载状态
5. 查看SnackBar提示

#### 修改流量限制

1. 点击"总流量限制"行
2. 在对话框中输入 "100 GB"
3. 查看自动转换的字节数: "107374182400"
4. 点击"保存"
5. 查看更新后的进度条和剩余流量

#### 调整账号过期时间

1. 点击用户基本信息卡片的"编辑"按钮
2. 点击"账号过期时间"字段
3. 在日期选择器中选择日期
4. 在时间选择器中选择时间
5. 点击"保存"按钮

## 代码质量

### 编码规范遵守情况

- ✅ 缩进2空格
- ✅ 使用明确的类型声明
- ✅ 避免无意义的try-catch
- ✅ 使用final声明不可变变量
- ✅ 正确的生命周期管理
- ✅ 遵循时间处理规范
- ✅ 使用formatBytes而非重复实现
- ✅ 清晰的命名和注释

### 性能优化

- ✅ 使用late延迟初始化
- ✅ 正确dispose控制器
- ✅ 避免不必要的rebuild
- ✅ 使用const构造函数
- ✅ 局部状态管理

## 贡献者指南

如需扩展或修改这些组件：

1. **添加新字段**: 在相应的_buildContent方法中添加新的输入控件
2. **修改样式**: 调整_buildInfoRow等通用方法
3. **增加验证**: 在_toggleEdit或_save方法中添加验证逻辑
4. **扩展功能**: 参考现有的流量编辑对话框，创建类似的编辑UI

## 相关资源

- [Flutter官方文档](https://flutter.dev/docs)
- [Material Design指南](https://material.io/design)
- [项目编码规范](.github/copilot-instructions.md)
- [组件使用指南](lib/component/low_admin/README.md)

