# 添加管理员权限检查显示管理主页按钮

## 问题描述

主页中的"前往管理主页"按钮应该只对拥有管理员权限（`is_admin: true`）的用户显示。

## 实现方案

### 1. 在 JWT Token 模型中添加 `isAdmin` 字段

在 `/lib/utils/auth/jwt_token_model.dart` 的 `SubjectAccess` 类中添加 `isAdmin` 字段：

```dart
@JsonSerializable()
class SubjectAccess {
  const SubjectAccess({
    required this.email,
    this.userId,
    this.userNewId,
    this.userName,
    this.isAdmin, // 新增字段
  });

  // ...existing code...

  @JsonKey(name: 'is_admin')
  final bool? isAdmin; // 新增字段

// ...existing code...
}
```

### 2. 在 AuthStore 中添加 `isAdmin` getter

在 `/lib/utils/auth/auth_store.dart` 中添加管理员权限检查方法：

```dart
bool get isAdmin {
  if (!isAuthenticated) return false;
  return _accessJWTTokenPayload?.subjectAccess?.isAdmin ?? false;
}
```

**检查逻辑：**

- 首先确认用户已认证
- 从访问令牌的 payload 中获取 `subject_access.is_admin` 字段
- 如果字段不存在或为 null，默认返回 false

### 3. 修改 home_page.dart 使用权限检查

**修改内容：**

1. **导入 AuthStore**
   ```dart
   import 'package:fl_app1/utils/auth/auth_store.dart';
   ```

2. **添加 AuthStore 监听器**
   ```dart
   final AuthStore _authStore = AuthStore();

   @override
   void initState() {
     super.initState();
     _authStore.addListener(_onAuthChanged);
   }

   @override
   void dispose() {
     _authStore.removeListener(_onAuthChanged);
     super.dispose();
   }

   void _onAuthChanged() {
     if (mounted) {
       setState(() {});
     }
   }
   ```

3. **条件显示管理主页按钮**
   ```dart
   if (_authStore.isAdmin) ...[
     ElevatedButton(
       onPressed: () => context.go('/low_admin'),
       child: const Text('前往管理主页'),
     ),
     const SizedBox(height: 8),
   ],
   ```

## 工作原理

1. **JWT Token 结构**
    - 访问令牌的 `subject_access` 对象中包含 `is_admin` 字段
    - 管理员用户的 `is_admin` 值为 `true`
    - 示例 Token Payload：
      ```json
      {
        "jti": "019a580e-cd98-73a9-acbc-b16cfcc61013",
        "exp": 1762415156,
        "iat": 1762413956,
        "role": "malio_postgrest_user",
        "subject_access": {
          "user_id": 18401,
          "user_new_id": "017aa5e9-e8c0-7000-a001-9e828b5fa184",
          "user_name": "技术",
          "email": "admin@yxikkj.top",
          "is_admin": true
        },
        "token_type": "access"
      }
      ```

2. **实时响应**
    - 监听 AuthStore 的变化
    - 当用户登录/登出时自动更新 UI
    - 当令牌刷新时自动重新检查权限

3. **安全性**
    - 仅在客户端隐藏按钮（UI 层面）
    - 服务端仍需进行权限验证
    - 防止未授权访问管理页面

## 修改文件

- `/lib/utils/auth/jwt_token_model.dart` - 在 `SubjectAccess` 类中添加 `isAdmin` 字段
- `/lib/utils/auth/auth_store.dart` - 添加 `isAdmin` getter
- `/lib/pages/home_page.dart` - 添加权限检查和条件渲染

## 测试建议

1. **普通用户测试**
    - 使用普通用户账号登录
    - 确认主页不显示"前往管理主页"按钮

2. **管理员测试**
    - 使用管理员账号登录
    - 确认主页显示"前往管理主页"按钮
    - 点击按钮可正常跳转到管理页面

3. **登录状态切换测试**
    - 登出后按钮应消失
    - 登录后（如果是管理员）按钮应出现

## 注意事项

- ✅ 符合编码规范，使用最精简的方法实现
- ✅ 没有使用无意义的 try-catch 包装
- ✅ 实时监听认证状态变化，无需手动刷新
- ⚠️ 这只是 UI 层面的权限控制，后端路由仍需进行权限验证

