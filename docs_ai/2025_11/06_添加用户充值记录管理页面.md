# 添加用户充值记录管理页面

## 操作日期

2025年01月06日

## 概述

添加了用户充值记录（user_pay_list）的查看和编辑功能，UI设计与用户购买记录（user_bought）页面保持一致。

## 新增文件

### 1. `/lib/pages/low_admin/user_pay_list.dart`

用户充值记录列表页面，提供以下功能：

- 查看所有充值记录
- 按用户ID搜索充值记录
- 点击用户ID跳转到用户详情页
- 展示充值状态（已完成/未完成）
- 显示交易单号、金额、支付方式、发票ID、备注等信息

**主要特性：**

- 使用 `LowAdminLayout` 布局，selectedIndex 设置为 3
- 支持搜索框实时清空
- 空状态提示优化
- 时间显示遵循 UTC → Local 转换规范
- 用户ID可点击跳转到用户详情

### 2. `/lib/pages/low_admin/user_pay_records.dart`

单个用户的充值记录详情页面，提供以下功能：

- 查看指定用户的所有充值记录
- 编辑充值记录（金额、交易单号、支付方式、发票ID、备注、完成状态）
- 删除充值记录（带确认对话框）
- 下拉刷新

**编辑功能字段：**

- 金额（支持小数和负数）
- 交易单号
- 支付方式ID
- 发票ID（可选）
- 备注（可选）
- 是否完成（开关）

## 修改文件

### 1. `/lib/routes.dart`

添加路由：

```dart
GoRoute
(
path: '/low_admin/user_pay_list',
name: 'low_admin_user_pay_list',
builder: (context, state) => const UserPayListPage
(
)
,
)
,
```

### 2. `/lib/pages/low_admin/low_admin_layout.dart`

在导航菜单中添加"充值记录"项：

```dart
NavigationItem
(
icon: Icons.account_balance_wallet,
label: '充值记录',
route
:
'
/low_admin/user_pay_list
'
,
)
,
```

### 3. `/lib/pages/low_admin/low_admin_home.dart`

在首页快捷操作中添加"充值记录"卡片：

```dart
_buildQuickActionCard
(
context: context,
icon: Icons.account_balance_wallet,
title: '充值记录',
description: '查看用户充值记录',
onTap: () => context.go('
/low_admin/user_pay_list
'
)
,
)
,
```

### 4. `/lib/pages/low_admin/user_v2.dart`

在用户详情页面添加"充值记录"入口：

- 添加 `_navigateToPayRecords()` 方法
- 添加"充值记录"卡片，可跳转到用户充值记录页面
- 导入 `UserPayRecordsPage`

## API 端点使用

### 获取充值记录

```dart
await
_restClient.fallback.getUserPayListApiV2LowAdminApiUserPayListGet
(
limit
:
3000
,
userId
:
userId
, // 可选，不传则查询所有
);
```

### 更新充值记录

```dart
await
_restClient.fallback.putUserPayListApiV2LowAdminApiUserPayListUserPayListIdPut
(
userPayListId: payIdInt,
body: WebSubFastapiRoutersApiVLowAdminApiUserPayListPutParamsModel(...),
);
```

### 删除充值记录

```dart
await
_restClient.fallback.deleteUserPayListApiV2LowAdminApiUserPayListUserPayListIdDelete
(
userPayListId
:
payIdInt
,
);
```

## 数据模型

### UserPayList

```dart
{id: String?,
createdAt: DateTime?,
updatedAt: DateTime?,
userId: int,
moneyAmount: String,
isFinish: bool,
tradeNo: String,
payMethodId: int,
configJson: dynamic?,
invoiceId: String?,
remark: String?,
}
```

## UI 设计特点

1. **状态标识**
    - 已完成：绿色标签
    - 未完成：橙色标签

2. **信息展示**
    - 交易单号作为标题
    - 记录ID作为副标题
    - 三列布局展示：用户ID、金额、支付方式
    - 两列布局展示：创建时间、更新时间
    - 可选字段：发票ID、备注

3. **交互功能**
    - 用户ID可点击跳转
    - 记录ID可点击复制（带复制图标和提示）
    - 搜索框支持清空按钮
    - 编辑按钮打开对话框
    - 删除按钮带二次确认

4. **编辑对话框**
    - 所有必填字段验证
    - 开关控制完成状态
    - 多行文本输入备注
    - 警告提示信息

## 遵循的规范

1. **API 调用规范**
    - ✅ 使用 Model 参数，避免手动构造 query string
    - ✅ 带访问令牌的 API 路径：`/api/v2/low_admin_api/user_pay_list/`

2. **时间处理规范**
    - ✅ API 返回 UTC 时间
    - ✅ 显示时转换为本地时间：`record.createdAt!.toLocal()`
    - ✅ 格式化显示：`DateFormat('yyyy-MM-dd HH:mm')`

3. **代码风格**
    - ✅ 最精简的方法实现功能
    - ✅ 避免无意义的 try-catch 包装
    - ✅ 使用单例模式的认证客户端

4. **UI/UX**
    - ✅ 与 user_bought 页面保持一致的设计风格
    - ✅ 响应式布局支持
    - ✅ 空状态和错误状态友好提示
    - ✅ 加载状态显示

## 测试建议

1. 测试搜索功能
    - 输入有效用户ID
    - 输入无效用户ID
    - 清空搜索框

2. 测试编辑功能
    - 修改金额（正数、负数、小数）
    - 修改完成状态
    - 验证必填字段

3. 测试删除功能
    - 确认删除
    - 取消删除

4. 测试时间显示
    - 验证时间显示为本地时间
    - 验证时区转换正确

5. 测试复制功能
    - 点击记录ID复制
    - 验证复制成功提示

6. 测试用户信息页跳转
    - 从用户详情页跳转到充值记录
    - 验证显示正确的用户充值数据

## 后续改进建议

1. 考虑添加批量操作功能
2. 添加导出功能（CSV/Excel）
3. 添加高级筛选（按日期范围、金额范围、支付方式等）
4. 添加统计图表展示
5. 考虑添加充值记录的审计日志

## 相关文件

- `/lib/api/models/user_pay_list.dart` - 数据模型（自动生成）
- `/lib/api/models/web_sub_fastapi_routers_api_v_low_admin_api_user_pay_list_get_user_bought_response.dart` - 响应模型（自动生成）
- `/lib/api/models/web_sub_fastapi_routers_api_v_low_admin_api_user_pay_list_put_params_model.dart` - 更新参数模型（自动生成）
- `/lib/api/fallback/fallback_client.dart` - API 客户端（自动生成）

