# ä»¤ç‰Œåˆ·æ–°æ—¶ä¿ç•™ç°æœ‰åˆ·æ–°ä»¤ç‰Œ

## ä¿®æ”¹æ—¥æœŸ

2025å¹´11æœˆ5æ—¥

## é—®é¢˜æè¿°

åœ¨ä»¤ç‰Œåˆ·æ–°æµç¨‹ä¸­ï¼Œå½“ API è¿”å›çš„ `refreshToken` ä¸º `null` æ—¶ï¼ˆä¾‹å¦‚åªåˆ·æ–°è®¿é—®ä»¤ç‰Œçš„åœºæ™¯ï¼‰ï¼ŒåŸæœ‰ä»£ç ä¼šåˆ é™¤ SharedPreferences
ä¸­å·²å­˜å‚¨çš„åˆ·æ–°ä»¤ç‰Œï¼Œå¯¼è‡´åˆ·æ–°ä»¤ç‰Œä¸¢å¤±ã€‚

## åŸæœ‰é€»è¾‘

```dart
// åˆ·æ–°ä»¤ç‰Œä¿å­˜åœ¨ SharedPreferences ä¸­
if (refreshToken != null) {
_refreshJWTToken = refreshToken;
await _prefs?.setString(AuthConstants.refreshTokenKey, refreshToken);
debugPrint('ğŸ’¾ ä¿å­˜ refreshToken åˆ° SharedPreferences');
_refreshJWTTokenPayload = _decodeToken(refreshToken);
debugPrint('ğŸ’¾ è§£æ refreshToken payload: ${_refreshJWTTokenPayload != null ? "æˆåŠŸ" : "å¤±è´¥"}');
} else {
await _prefs?.remove(AuthConstants.refreshTokenKey); // âŒ ä¼šåˆ é™¤å·²æœ‰çš„åˆ·æ–°ä»¤ç‰Œ
}
```

**é—®é¢˜**ï¼š

- å½“ `refreshToken` ä¸º `null` æ—¶ï¼Œä¼šè°ƒç”¨ `_prefs?.remove()` åˆ é™¤å·²å­˜å‚¨çš„åˆ·æ–°ä»¤ç‰Œ
- è¿™ä¼šå¯¼è‡´åç»­æ— æ³•ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œé‡æ–°è·å–è®¿é—®ä»¤ç‰Œ

## ä¿®æ”¹åçš„é€»è¾‘

```dart
// åˆ·æ–°ä»¤ç‰Œä¿å­˜åœ¨ SharedPreferences ä¸­
// åªæœ‰å½“ refreshToken ä¸ä¸º null æ—¶æ‰æ›´æ–°
if (refreshToken != null) {
_refreshJWTToken = refreshToken;
await _prefs?.setString(AuthConstants.refreshTokenKey, refreshToken);
debugPrint('ğŸ’¾ ä¿å­˜ refreshToken åˆ° SharedPreferences');
_refreshJWTTokenPayload = _decodeToken(refreshToken);
debugPrint('ğŸ’¾ è§£æ refreshToken payload: ${_refreshJWTTokenPayload != null ? "æˆåŠŸ" : "å¤±è´¥"}');
} else {
// refreshToken ä¸º null æ—¶ï¼Œä¸ä¿®æ”¹ç°æœ‰çš„åˆ·æ–°ä»¤ç‰Œ
debugPrint('ğŸ’¾ refreshToken ä¸º nullï¼Œä¿ç•™ç°æœ‰çš„åˆ·æ–°ä»¤ç‰Œ');
}
```

**æ”¹è¿›**ï¼š

- âœ… å½“ `refreshToken` ä¸º `null` æ—¶ï¼Œä¸åˆ é™¤å·²æœ‰çš„åˆ·æ–°ä»¤ç‰Œ
- âœ… ä¿ç•™ç°æœ‰çš„åˆ·æ–°ä»¤ç‰Œï¼Œç¡®ä¿åç»­å¯ä»¥ç»§ç»­ä½¿ç”¨
- âœ… æ·»åŠ æ—¥å¿—è¯´æ˜ä¿ç•™æ“ä½œ

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šå®Œæ•´ä»¤ç‰Œåˆ·æ–°

API è¿”å›æ–°çš„è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œï¼š

```dart
await _setTokens
('new_access_token
'
,
'
new_refresh_token
'
, // é null
);
```

**ç»“æœ**ï¼š

- å†…å­˜ä¸­çš„è®¿é—®ä»¤ç‰Œæ›´æ–°ä¸ºæ–°å€¼
- SharedPreferences ä¸­çš„åˆ·æ–°ä»¤ç‰Œæ›´æ–°ä¸ºæ–°å€¼

### åœºæ™¯2ï¼šä»…åˆ·æ–°è®¿é—®ä»¤ç‰Œ

API åªè¿”å›æ–°çš„è®¿é—®ä»¤ç‰Œï¼Œä¸è¿”å›åˆ·æ–°ä»¤ç‰Œï¼š

```dart
await _setTokens
('new_access_token
'
,
null
, // ä»…åˆ·æ–°è®¿é—®ä»¤ç‰Œ
);
```

**ç»“æœ**ï¼š

- å†…å­˜ä¸­çš„è®¿é—®ä»¤ç‰Œæ›´æ–°ä¸ºæ–°å€¼
- âœ… SharedPreferences ä¸­çš„åˆ·æ–°ä»¤ç‰Œ**ä¿æŒä¸å˜**ï¼ˆä¸åˆ é™¤ï¼‰

### åœºæ™¯3ï¼šç™»å‡ºæ“ä½œ

éœ€è¦æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œæ—¶ï¼Œåº”è¯¥è°ƒç”¨ `logout()` æ–¹æ³•ï¼š

```dart
await logout();
```

**ç»“æœ**ï¼š

- æ¸…ç©ºå†…å­˜ä¸­çš„è®¿é—®ä»¤ç‰Œ
- æ¸…ç©ºå†…å­˜ä¸­çš„åˆ·æ–°ä»¤ç‰Œ
- åˆ é™¤ SharedPreferences ä¸­çš„åˆ·æ–°ä»¤ç‰Œ
- åœæ­¢ä»¤ç‰Œåˆ·æ–°å®šæ—¶å™¨

## æ—¥å¿—è¾“å‡º

### å½“ refreshToken æœ‰å€¼æ—¶

```
flutter: ğŸ’¾ _setTokens è¢«è°ƒç”¨: accessToken=å­˜åœ¨, refreshToken=å­˜åœ¨
flutter: ğŸ’¾ è®¾ç½®å†…å­˜ä¸­çš„ _accessJWTToken
flutter: ğŸ’¾ è§£æ accessToken payload: æˆåŠŸ
flutter: ğŸ’¾ ä¿å­˜ refreshToken åˆ° SharedPreferences
flutter: ğŸ’¾ è§£æ refreshToken payload: æˆåŠŸ
```

### å½“ refreshToken ä¸º null æ—¶

```
flutter: ğŸ’¾ _setTokens è¢«è°ƒç”¨: accessToken=å­˜åœ¨, refreshToken=null
flutter: ğŸ’¾ è®¾ç½®å†…å­˜ä¸­çš„ _accessJWTToken
flutter: ğŸ’¾ è§£æ accessToken payload: æˆåŠŸ
flutter: ğŸ’¾ refreshToken ä¸º nullï¼Œä¿ç•™ç°æœ‰çš„åˆ·æ–°ä»¤ç‰Œ
```

## ä¼˜åŠ¿

1. âœ… **é˜²æ­¢è¯¯åˆ é™¤**: ä¸ä¼šå› ä¸º API è¿”å› null è€Œåˆ é™¤æœ‰æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ
2. âœ… **æ›´çµæ´»**: æ”¯æŒåªåˆ·æ–°è®¿é—®ä»¤ç‰Œçš„åœºæ™¯
3. âœ… **æ›´å®‰å…¨**: ä¿ç•™åˆ·æ–°ä»¤ç‰Œç¡®ä¿ç”¨æˆ·ä¸ä¼šæ„å¤–ç™»å‡º
4. âœ… **æ—¥å¿—æ¸…æ™°**: æ˜ç¡®è¯´æ˜ä¿ç•™æ“ä½œ

## æ³¨æ„äº‹é¡¹

å¦‚æœéœ€è¦æ˜¾å¼æ¸…é™¤åˆ·æ–°ä»¤ç‰Œï¼Œåº”è¯¥ï¼š

1. è°ƒç”¨ `logout()` æ–¹æ³•ï¼ˆæ¨èï¼‰
2. æˆ–è€…ä¼ é€’ç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯ `null`ï¼ˆä¸æ¨èï¼‰

## æ€»ç»“

âœ… **ä¿®æ”¹å®Œæˆ**:

- `refreshToken` ä¸º `null` æ—¶ä¿ç•™ç°æœ‰çš„åˆ·æ–°ä»¤ç‰Œ
- åªåœ¨æ˜ç¡®æä¾›æ–°å€¼æ—¶æ‰æ›´æ–°åˆ·æ–°ä»¤ç‰Œ
- ç¬¦åˆé¢„æœŸçš„ä»¤ç‰Œç®¡ç†è¡Œä¸º

âœ… **ä»£ç è´¨é‡**:

- æ— é”™è¯¯ã€æ— è­¦å‘Š
- é€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£
- æ—¥å¿—å®Œå–„ï¼Œä¾¿äºè°ƒè¯•

