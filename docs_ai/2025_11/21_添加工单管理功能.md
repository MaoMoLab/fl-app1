# 低权限管理后台-工单功能实现

## 日期

2025-11-21

## 操作说明

添加低权限管理后台的工单管理功能，包括工单列表查看和基础筛选功能。

## 实现的功能

### 1. 工单列表页面

- 路径：`/Users/inprtx/git/hub/InPRTx/fl-app1/lib/page/low_admin/ticket_list/low_admin_ticket_list_page.dart`
- 功能特性：
    - 工单列表展示
    - 支持查询参数筛选 (q参数)
    - 支持向下滚动自动加载更多
    - 分页加载（每页20条）
    - 显示工单状态（待处理/处理中/已解决/已关闭）
    - 显示工单基本信息（ID、用户ID、标题、创建时间、更新时间）
    - Markdown格式标识
    - 下拉刷新
    - 加载更多指示器
    - 到底提示
    - 点击跳转到工单详情（路由已预留）

### 2. 导航布局更新

- 文件：`/Users/inprtx/git/hub/InPRTx/fl-app1/lib/page/low_admin/low_admin_layout.dart`
- 变更：
    - 在导航菜单中添加"工单管理"项
    - 图标：`Icons.support_agent`
    - 路由：`/low_admin/ticket`
    - 位置：在"旧版商品"和"设置"之间

### 3. 路由配置更新

- 文件：`/Users/inprtx/git/hub/InPRTx/fl-app1/lib/router/low_admin_routes.dart`
- 变更：
    - 导入工单列表页面
    - 添加工单路由 `/low_admin/ticket`
    - 更新 `_selectedIndexForLocation` 函数，将工单路由映射到索引5
    - 设置路由映射到索引6

## API 使用

### 工单列表 API

- 端点：`GET /api/v2/low_admin_api/ticket/`
- 方法：`getTicketApiV2LowAdminApiTicketGet`
- 参数：
    - `offset`: 偏移量（默认：0）
    - `limit`: 限制数量（默认：3000）
    - `q`: 查询参数（可选）
    - `from_iso`: 起始时间（可选）
    - `to_iso`: 结束时间（可选）
- 响应类型：`GetTicketListResponse`
    - `isSuccess`: 是否成功
    - `message`: 消息
    - `resultList`: `List<UserTicketView>` 工单列表

### 数据模型

- `UserTicketView`: 工单视图模型
    - `id`: 工单ID
    - `userId`: 用户ID
    - `title`: 标题
    - `ticketStatus`: 工单状态（枚举）
    - `isMarkdown`: 是否Markdown格式
    - `createdAt`: 创建时间
    - `updatedAt`: 更新时间
    - `messages`: 消息列表（可选）
    - `userIds`: 用户ID列表（可选）

- `TicketStatusEnum`: 工单状态枚举
    - `open`: 开放
    - `closed`: 已关闭
    - `waiting`: 等待中
    - `pending`: 待处理

## 代码规范遵守

### 1. 命名规范

- ✅ 文件命名：`low_admin_ticket_list_page.dart` (小写+下划线)
- ✅ 类命名：`LowAdminTicketListPage` (大驼峰)
- ✅ 变量命名：小驼峰，布尔值使用 `is` 前缀
- ✅ 私有变量：使用 `_` 前缀

### 2. 构造规范

- ✅ StatefulWidget 使用 `const` 构造
- ✅ 构造参数使用命名可选参数 `{super.key}`
- ✅ 所有字段为 `final`

### 3. API 调用规范

- ✅ 使用 `getApiClient()` 获取客户端
- ✅ 使用完整的方法名调用 API
- ✅ 使用命名参数传递查询参数
- ✅ 不手动构造 query string

### 4. 时间处理规范

- ✅ API 返回的 DateTime 为 UTC 时间
- ✅ 显示时使用 `.toLocal()` 转换为本地时间
- ✅ 使用 `DateFormat` 格式化时间显示

### 5. 状态管理

- ✅ 使用 `setState` 更新UI状态
- ✅ 使用 `_isLoading` 标记初始加载状态
- ✅ 使用 `_isLoadingMore` 标记加载更多状态
- ✅ 使用 `_errorMessage` 存储错误信息
- ✅ 使用 `_offset` 追踪分页偏移量
- ✅ 使用 `_hasMore` 标记是否还有更多数据

### 6. 滚动加载

- ✅ 使用 `ScrollController` 监听滚动事件
- ✅ 在距离底部 200px 时自动触发加载更多
- ✅ 防止重复加载（检查 `_isLoading` 和 `_isLoadingMore`）
- ✅ 根据返回数据量判断是否还有更多数据
- ✅ 在 dispose 中正确释放资源

### 7. UI 规范

- ✅ 使用 Material Design 组件
- ✅ 使用 `RefreshIndicator` 支持下拉刷新
- ✅ 空状态、错误状态、加载状态都有专门的UI展示
- ✅ 使用 `InkWell` 提供点击反馈
- ✅ 使用 `Card` 组件展示列表项
- ✅ 显示"加载更多"指示器
- ✅ 显示"到底了"提示

### 8. 代码简洁性

- ✅ 避免无意义的 try-catch
- ✅ 使用精简的方法实现功能
- ✅ 合理拆分组件方法

## 待实现功能

1. **工单详情页面**
    - 路由：`/low_admin/ticket/:id`
    - 功能：查看工单完整信息、消息历史、回复工单

2. **工单回复功能**
    - API：`POST /api/v2/low_admin_api/ticket/{ticket_id}/reply`
    - 功能：管理员回复工单并更新状态

3. **高级筛选**
    - 日期范围筛选（from_iso, to_iso）
    - 状态筛选
    - 分页功能

4. **工单统计**
    - 各状态工单数量统计
    - 待处理工单提醒

## 文件结构

```
lib/
├── page/
│   └── low_admin/
│       ├── low_admin_layout.dart (已更新)
│       └── ticket_list/
│           └── low_admin_ticket_list_page.dart (新建)
└── router/
    └── low_admin_routes.dart (已更新)
```

## 测试建议

1. 测试空状态显示
2. 测试搜索功能（user_id:123）
3. 测试下拉刷新
4. 测试向下滚动自动加载更多
5. 测试分页功能（确保每页加载20条）
6. 测试"到底了"提示显示
7. 测试不同工单状态的颜色显示
8. 测试时间显示是否为本地时间
9. 测试错误状态处理
10. 测试响应式布局（手机/平板）
11. 测试快速滚动时不会重复加载
12. 测试搜索后重置分页状态

## 注意事项

1. 该 API 需要访问令牌（/api/v2/low_admin_api 路径）
2. 工单详情页面路由已预留，但尚未实现
3. 时间显示已按规范转换为本地时间
4. 使用了统一的 API 调用方式（通过 model 参数）
5. 遵循了 Flutter 开发规范中的所有要求

