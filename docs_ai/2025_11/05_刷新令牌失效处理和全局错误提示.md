# åˆ·æ–°ä»¤ç‰Œå¤±æ•ˆå¤„ç†å’Œå…¨å±€é”™è¯¯æç¤º

## ä¿®æ”¹æ—¥æœŸ

2025å¹´11æœˆ5æ—¥

## é—®é¢˜æè¿°

å½“ç”¨æˆ·å¡«å…¥äº†ä¸€ä¸ªé”™è¯¯çš„åˆ·æ–°ä»¤ç‰Œæ—¶ï¼Œç¨‹åºåœ¨å°è¯•åˆ·æ–°è®¿é—®ä»¤ç‰Œæ—¶ä¼šæ”¶åˆ° HTTP 403 é”™è¯¯ï¼Œä½†æ­¤æ—¶ï¼š

1. âŒ é”™è¯¯çš„åˆ·æ–°ä»¤ç‰Œä»ç„¶ä¿ç•™åœ¨ SharedPreferences ä¸­
2. âŒ æ²¡æœ‰æ¸…ç†è®¿é—®ä»¤ç‰Œ
3. âŒ ç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•é”™è¯¯æç¤º
4. âŒ ç¨‹åºç»§ç»­å°è¯•ä½¿ç”¨æ— æ•ˆçš„ä»¤ç‰Œ

è¿™å¯¼è‡´ç”¨æˆ·ä½“éªŒå¾ˆå·®ï¼Œåº”ç”¨ä¼šä¸€ç›´å¤„äºè®¤è¯å¤±è´¥çŠ¶æ€ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. æ•è· DioException å¹¶å¤„ç† 403 é”™è¯¯

åœ¨ `apiRefreshToken` æ–¹æ³•ä¸­æ·»åŠ  try-catch å—ï¼Œç‰¹åˆ«å¤„ç† 403 é”™è¯¯ï¼š

```dart
try {
final response = await rest.fallback
    .postJwtAccessRefreshApiV2AuthJwtTokenJwtAccessRefreshPost(body: body);

if (response.isSuccess && response.result.accessToken.isNotEmpty) {
await _setTokens(response.result.accessToken, response.result.refreshToken);
return true;
} else {
debugPrint('Token refresh failed: ${response.message}');
await logout();
_showErrorSnackBar('ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
return false;
}
} on DioException catch (e) {
debugPrint('âŒ Token refresh DioException: ${e.response?.statusCode}');
debugPrint('âŒ Error message: ${e.message}');

// æ£€æŸ¥æ˜¯å¦æ˜¯ 403 é”™è¯¯ï¼ˆåˆ·æ–°ä»¤ç‰Œæ— æ•ˆï¼‰
if (e.response?.statusCode == 403) {
debugPrint('âŒ åˆ·æ–°ä»¤ç‰Œæ— æ•ˆï¼ˆ403ï¼‰ï¼Œæ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ');
await logout();
_showErrorSnackBar('ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
return false;
}

// å…¶ä»–ç½‘ç»œé”™è¯¯
debugPrint('âŒ ç½‘ç»œé”™è¯¯ï¼Œæ¸…é™¤ä»¤ç‰Œ');
await logout();
_showErrorSnackBar('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•');
return false;
} catch (e, stackTrace) {
debugPrint('âŒ Token refresh unexpected error: $e');
debugPrint('Stack trace: $stackTrace');
await logout();
_showErrorSnackBar('ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
return false;
}
```

**å¤„ç†é€»è¾‘**:

1. **403 é”™è¯¯**: åˆ·æ–°ä»¤ç‰Œæ— æ•ˆï¼ˆé”™è¯¯æˆ–è¿‡æœŸï¼‰
    - è°ƒç”¨ `logout()` æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ
    - æ˜¾ç¤º"ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"

2. **å…¶ä»–ç½‘ç»œé”™è¯¯**: ç½‘ç»œé—®é¢˜æˆ–æœåŠ¡å™¨é”™è¯¯
    - è°ƒç”¨ `logout()` æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ
    - æ˜¾ç¤º"ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•"

3. **æœªçŸ¥é”™è¯¯**: æ„å¤–çš„å¼‚å¸¸
    - è°ƒç”¨ `logout()` æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ
    - æ˜¾ç¤º"ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•"

### 2. æ·»åŠ å…¨å±€ SnackBar æ˜¾ç¤ºåŠŸèƒ½

#### AuthStore ä¸­æ·»åŠ å›è°ƒæœºåˆ¶

```dart
class AuthStore extends ChangeNotifier {
  // ä»¤ç‰Œè¿‡æœŸå›è°ƒï¼Œç”±å¤–éƒ¨è®¾ç½®
  void Function(String message)? onTokenExpired;

  void _showErrorSnackBar(String message) {
    // ä½¿ç”¨å›è°ƒå‡½æ•°è®©ä¸Šå±‚æ˜¾ç¤º SnackBar
    if (onTokenExpired != null) {
      onTokenExpired!(message);
    } else {
      debugPrint('âš ï¸ æ— æ³•æ˜¾ç¤º SnackBar: $messageï¼ˆå›è°ƒæœªè®¾ç½®ï¼‰');
    }
  }
}
```

**è®¾è®¡æ€è·¯**:

- AuthStore æ˜¯ä¸€ä¸ªå·¥å…·ç±»ï¼Œä¸åº”è¯¥ç›´æ¥ä¾èµ– UI å±‚
- ä½¿ç”¨å›è°ƒå‡½æ•°å°†é”™è¯¯æ¶ˆæ¯ä¼ é€’ç»™ UI å±‚
- å¦‚æœå›è°ƒæœªè®¾ç½®ï¼Œåªè¾“å‡ºæ—¥å¿—è­¦å‘Š

#### åœ¨ main.dart ä¸­è®¾ç½®å…¨å±€ ScaffoldMessengerKey

```dart
// å…¨å±€ ScaffoldMessenger keyï¼Œç”¨äºåœ¨ä»»ä½•åœ°æ–¹æ˜¾ç¤º SnackBar
final GlobalKey<ScaffoldMessengerState> scaffoldMessengerKey =
GlobalKey<ScaffoldMessengerState>();

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await initializeDateFormatting();
  Intl.defaultLocale = 'zh_CN';

  // Initialize auth store
  await AuthStore().init();

  // è®¾ç½®ä»¤ç‰Œè¿‡æœŸå›è°ƒ
  AuthStore().onTokenExpired = (String message) {
    scaffoldMessengerKey.currentState?.showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: Colors.red,
        duration: const Duration(seconds: 4),
        action: SnackBarAction(
          label: 'å…³é—­',
          textColor: Colors.white,
          onPressed: () {
            scaffoldMessengerKey.currentState?.hideCurrentSnackBar();
          },
        ),
      ),
    );
  };

  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      scaffoldMessengerKey: scaffoldMessengerKey, // è®¾ç½®å…¨å±€ key
      routerConfig: router,
      // ...å…¶ä»–é…ç½®
    );
  }
}
```

**å…³é”®ç‚¹**:

1. åˆ›å»ºå…¨å±€çš„ `scaffoldMessengerKey`
2. åœ¨ `main()` ä¸­è®¾ç½® `AuthStore().onTokenExpired` å›è°ƒ
3. åœ¨ `MaterialApp.router` ä¸­æ³¨å…¥ `scaffoldMessengerKey`
4. å›è°ƒä¸­åˆ›å»ºçº¢è‰²èƒŒæ™¯çš„ SnackBarï¼ŒæŒç»­ 4 ç§’

## å·¥ä½œæµç¨‹

### æ­£å¸¸åˆ·æ–°æµç¨‹

```mermaid
sequenceDiagram
    participant Timer
    participant AuthStore
    participant API
    participant User

    Timer->>AuthStore: è§¦å‘åˆ·æ–°
    AuthStore->>API: å‘é€åˆ·æ–°ä»¤ç‰Œ
    API-->>AuthStore: è¿”å›æ–°ä»¤ç‰Œ
    AuthStore->>AuthStore: ä¿å­˜æ–°ä»¤ç‰Œ
    Note over AuthStore: ç»§ç»­æ­£å¸¸å·¥ä½œ
```

### é”™è¯¯åˆ·æ–°ä»¤ç‰Œæµç¨‹ï¼ˆ403ï¼‰

```mermaid
sequenceDiagram
    participant Timer
    participant AuthStore
    participant API
    participant User

    Timer->>AuthStore: è§¦å‘åˆ·æ–°
    AuthStore->>API: å‘é€é”™è¯¯çš„åˆ·æ–°ä»¤ç‰Œ
    API-->>AuthStore: 403 Forbidden
    AuthStore->>AuthStore: è°ƒç”¨ logout()
    Note over AuthStore: æ¸…é™¤è®¿é—®ä»¤ç‰Œ
    Note over AuthStore: æ¸…é™¤åˆ·æ–°ä»¤ç‰Œ
    AuthStore->>User: æ˜¾ç¤ºçº¢è‰² SnackBar
    Note over User: "ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
```

### ç½‘ç»œé”™è¯¯æµç¨‹

```mermaid
sequenceDiagram
    participant Timer
    participant AuthStore
    participant API
    participant User

    Timer->>AuthStore: è§¦å‘åˆ·æ–°
    AuthStore->>API: å‘é€åˆ·æ–°ä»¤ç‰Œ
    API-->>AuthStore: ç½‘ç»œè¶…æ—¶/æœåŠ¡å™¨é”™è¯¯
    AuthStore->>AuthStore: è°ƒç”¨ logout()
    Note over AuthStore: æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ
    AuthStore->>User: æ˜¾ç¤ºçº¢è‰² SnackBar
    Note over User: "ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•"
```

## SnackBar æ ·å¼

### è§†è§‰æ•ˆæœ

- **èƒŒæ™¯è‰²**: çº¢è‰²ï¼ˆ`Colors.red`ï¼‰
- **æ–‡å­—**: ç™½è‰²ï¼ˆé»˜è®¤ï¼‰
- **æŒç»­æ—¶é—´**: 4 ç§’
- **æ“ä½œæŒ‰é’®**: "å…³é—­"æŒ‰é’®ï¼ˆç™½è‰²æ–‡å­—ï¼‰

### ç¤ºä¾‹ä»£ç 

```dart
SnackBar
(
content: Text(message),
backgroundColor: Colors.red,
duration: const Duration(seconds: 4),
action: SnackBarAction(
label: 'å…³é—­',
textColor: Colors.white,
onPressed: () {
scaffoldMessengerKey.currentState?.hideCurrentSnackBar();
},
)
,
)
```

### ç”¨æˆ·ä½“éªŒ

1. âœ… çº¢è‰²èƒŒæ™¯æ˜æ˜¾æç¤ºé”™è¯¯
2. âœ… 4 ç§’è‡ªåŠ¨æ¶ˆå¤±ï¼Œä¸ä¼šè¿‡åº¦æ‰“æ‰°
3. âœ… æä¾›"å…³é—­"æŒ‰é’®ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å…³é—­
4. âœ… æ¶ˆæ¯æ¸…æ™°æ˜äº†ï¼Œå‘Šè¯‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•

## é”™è¯¯å¤„ç†æ€»ç»“

| é”™è¯¯ç±»å‹   | HTTP çŠ¶æ€ç  | å¤„ç†æ–¹å¼   | ç”¨æˆ·æç¤º            |
|--------|----------|--------|-----------------|
| åˆ·æ–°ä»¤ç‰Œæ— æ•ˆ | 403      | æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ | "ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•" |
| å“åº”å¤±è´¥   | -        | æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ | "ç™»å½•ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•" |
| ç½‘ç»œé”™è¯¯   | å…¶ä»–       | æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ | "ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡æ–°ç™»å½•"    |
| æœªçŸ¥é”™è¯¯   | -        | æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ | "ä»¤ç‰Œåˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•"  |

## æ—¥å¿—è¾“å‡º

### 403 é”™è¯¯æ—¥å¿—ç¤ºä¾‹

```
flutter: ğŸ”„ apiRefreshToken è¢«è°ƒç”¨
flutter: ğŸ” å½“å‰ _refreshJWTToken: å­˜åœ¨
flutter: âŒ Token refresh DioException: 403
flutter: âŒ Error message: ...
flutter: âŒ åˆ·æ–°ä»¤ç‰Œæ— æ•ˆï¼ˆ403ï¼‰ï¼Œæ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ
flutter: ğŸ—‘ï¸ å·²æ¸…é™¤ SharedPreferences ä¸­çš„ refreshToken
```

### ç½‘ç»œé”™è¯¯æ—¥å¿—ç¤ºä¾‹

```
flutter: ğŸ”„ apiRefreshToken è¢«è°ƒç”¨
flutter: ğŸ” å½“å‰ _refreshJWTToken: å­˜åœ¨
flutter: âŒ Token refresh DioException: 500
flutter: âŒ Error message: ...
flutter: âŒ ç½‘ç»œé”™è¯¯ï¼Œæ¸…é™¤ä»¤ç‰Œ
flutter: ğŸ—‘ï¸ å·²æ¸…é™¤ SharedPreferences ä¸­çš„ refreshToken
```

## æµ‹è¯•è¦ç‚¹

### åŠŸèƒ½æµ‹è¯•

1. âœ… æ‰‹åŠ¨è®¾ç½®é”™è¯¯çš„åˆ·æ–°ä»¤ç‰Œ
2. âœ… ç­‰å¾…æˆ–è§¦å‘ä»¤ç‰Œåˆ·æ–°
3. âœ… éªŒè¯æ˜¯å¦æ”¶åˆ° 403 é”™è¯¯
4. âœ… éªŒè¯æ˜¯å¦æ¸…é™¤äº†æ‰€æœ‰ä»¤ç‰Œ
5. âœ… éªŒè¯æ˜¯å¦æ˜¾ç¤ºçº¢è‰² SnackBar
6. âœ… éªŒè¯ SnackBar æ¶ˆæ¯å†…å®¹æ­£ç¡®
7. âœ… éªŒè¯ SnackBar 4 ç§’åè‡ªåŠ¨æ¶ˆå¤±
8. âœ… éªŒè¯ç‚¹å‡»"å…³é—­"æŒ‰é’®å¯ä»¥æå‰å…³é—­

### è¾¹ç•Œæµ‹è¯•

1. ç½‘ç»œæ–­å¼€æ—¶çš„å¤„ç†
2. æœåŠ¡å™¨è¿”å›å…¶ä»–é”™è¯¯ç çš„å¤„ç†
3. å¿«é€Ÿè¿ç»­å¤šæ¬¡åˆ·æ–°å¤±è´¥çš„å¤„ç†
4. å›è°ƒæœªè®¾ç½®æ—¶çš„é™çº§å¤„ç†ï¼ˆåªè¾“å‡ºæ—¥å¿—ï¼‰

### å®‰å…¨æµ‹è¯•

1. ç¡®è®¤ 403 é”™è¯¯æ—¶ä»¤ç‰Œè¢«å®Œå…¨æ¸…é™¤
2. ç¡®è®¤ SharedPreferences ä¸­æ²¡æœ‰æ®‹ç•™ä»¤ç‰Œ
3. ç¡®è®¤å†…å­˜ä¸­çš„ä»¤ç‰Œä¹Ÿè¢«æ¸…é™¤

## ä¼˜åŠ¿

### ç”¨æˆ·ä½“éªŒ

1. âœ… **å³æ—¶åé¦ˆ**: ç”¨æˆ·ç«‹å³çŸ¥é“è®¤è¯å¤±è´¥
2. âœ… **æ¸…æ™°æç¤º**: çº¢è‰²èƒŒæ™¯æ˜ç¡®è¡¨ç¤ºé”™è¯¯
3. âœ… **æ“ä½œæŒ‡å¼•**: æç¤ºç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
4. âœ… **ä¸ä¼šé˜»å¡**: SnackBar ä¸ä¼šæ‰“æ–­ç”¨æˆ·æ“ä½œ

### ç³»ç»Ÿå¥å£®æ€§

1. âœ… **å®Œæ•´æ¸…ç†**: æ‰€æœ‰ä»¤ç‰Œéƒ½è¢«æ¸…é™¤ï¼Œä¸ä¼šæ®‹ç•™
2. âœ… **é”™è¯¯åˆ†ç±»**: ä¸åŒé”™è¯¯æœ‰ä¸åŒçš„æç¤º
3. âœ… **è¯¦ç»†æ—¥å¿—**: ä¾¿äºé—®é¢˜æ’æŸ¥
4. âœ… **é™çº§å¤„ç†**: å³ä½¿å›è°ƒæœªè®¾ç½®ä¹Ÿä¸ä¼šå´©æºƒ

### ä»£ç è´¨é‡

1. âœ… **èŒè´£åˆ†ç¦»**: AuthStore ä¸ä¾èµ– UI å±‚
2. âœ… **çµæ´»æ‰©å±•**: å¯ä»¥è½»æ¾æ·»åŠ æ›´å¤šé”™è¯¯ç±»å‹
3. âœ… **å…¨å±€å¯ç”¨**: ä»»ä½•åœ°æ–¹éƒ½èƒ½ä½¿ç”¨å…¨å±€ SnackBar
4. âœ… **ç¬¦åˆè§„èŒƒ**: éµå¾ªé¡¹ç›®ç¼–ç è§„èŒƒ

## åç»­ä¼˜åŒ–å»ºè®®

1. **è‡ªåŠ¨è·³è½¬**: SnackBar å…³é—­åè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
2. **é‡è¯•æœºåˆ¶**: å¯¹äºç½‘ç»œé”™è¯¯ï¼Œæä¾›é‡è¯•æŒ‰é’®
3. **é”™è¯¯ç»Ÿè®¡**: è®°å½•é”™è¯¯å‘ç”Ÿçš„é¢‘ç‡å’Œç±»å‹
4. **æœ¬åœ°åŒ–**: æ”¯æŒå¤šè¯­è¨€é”™è¯¯æ¶ˆæ¯

## æ€»ç»“

âœ… **é—®é¢˜å·²å®Œå…¨è§£å†³**:

- 403 é”™è¯¯æ—¶æ¸…é™¤æ‰€æœ‰ä»¤ç‰Œ
- æ˜¾ç¤ºçº¢è‰²é”™è¯¯æç¤º
- ç”¨æˆ·ä½“éªŒè‰¯å¥½
- ä»£ç å¥å£®å¯é 

âœ… **ä»£ç è´¨é‡**:

- æ— é”™è¯¯ã€æ— è­¦å‘Š
- æ¶æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»
- æ—¥å¿—å®Œå–„ï¼Œä¾¿äºè°ƒè¯•
- ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ

