# 全局时区显示优化

**日期**: 2025年11月08日  
**类型**: 功能优化
**更新**: 优化时区清除功能，强制重置为 Asia/Shanghai

## 概述

将项目中所有时间处理从 `DateTime.toLocal()` 升级为使用 `tz.TZDateTime.now(tz.local)`，以更精确地处理本地时区显示。同时在
`main.dart` 中初始化全局时区，默认为 `Asia/Shanghai`，可通过系统设置页面自定义。

**重要更新**：优化了时区设置页面的"清除"功能，现在点击"重置为默认"按钮会强制将时区设置为 `Asia/Shanghai`
并保存，而不是清空设置。这确保应用始终有一个明确的时区配置。

## 修改文件

### 1. main.dart - 全局时区初始化

**文件**: `/lib/main.dart`

#### 变更内容

1. **导入 LocalTimeStore**

```dart
import 'package:fl_app1/store/local_time_store.dart';
```

2. **初始化时区逻辑**

```dart
// Initialize LocalTimeStore to get saved timezone
await LocalTimeStore().init();

// Get saved timezone or use default Asia/Shanghai
final String timeZoneName = LocalTimeStore().fixedTimeZone ?? 'Asia/Shanghai';

try {
  final tz.Location location = tz.getLocation(timeZoneName);
  tz.setLocalLocation(location);
} catch (e) {
  // If timezone is invalid, fallback to Asia/Shanghai
  tz.setLocalLocation(tz.getLocation('Asia/Shanghai'));
}
```

**说明**：

- 默认时区：`Asia/Shanghai`（东八区）
- 可通过 `/system/settings/local-time` 页面自定义时区
- 如果设置的时区无效，自动回退到 `Asia/Shanghai`
- 应用启动时自动应用保存的时区设置
- **清除/重置功能**：点击"重置为默认"按钮会强制设置为 `Asia/Shanghai` 并保存到存储，确保应用始终有明确的时区配置

### 2. 时区设置页面优化

**文件**: `/lib/page/system/settings/system_local_time_page.dart`

#### 变更内容

**优化清除功能逻辑**：

```dart
Future<void> _clear() async {
  // 清除时强制设置为 Asia/Shanghai
  const String defaultTimeZone = 'Asia/Shanghai';
  await _store.setFixedTimeZone(defaultTimeZone);
  _controller.text = defaultTimeZone;
  _selectedTimeZone = defaultTimeZone;
  
  // 设置 tz package 的本地时区
  try {
    final tz.Location? loc = _resolveLocation(defaultTimeZone);
    if (loc != null) {
      tz.setLocalLocation(loc);
    }
  } catch (_) {
    // ignore
  }
  
  if (!mounted) return;
  ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('已重置为默认时区 (Asia/Shanghai)')));
  setState(() {});
}
```

**改进点**：

- ✅ 按钮文字从"清除"改为"重置为默认"，更清晰
- ✅ 清除时不再设置为 `null`，而是强制设置为 `Asia/Shanghai`
- ✅ 确保时区设置始终有值，避免空值导致的不确定行为
- ✅ 更新说明文字，明确告知用户默认时区和重置行为

### 3. 组件文件更新

#### 2.1 EditableUserV2InfoCardComponent

**文件**: `/lib/component/low_admin/editable_user_v2_info_card_component.dart`

#### 变更内容

1. **添加时区包导入**

```dart
import 'package:timezone/timezone.dart' as tz;
```

2. **更新时间格式化方法**

```dart
String _formatDateTime(DateTime? dateTime) {
  if (dateTime == null) return 'N/A';
  final tz.TZDateTime localDateTime = tz.TZDateTime.from(dateTime, tz.local);
  return DateFormat('yyyy-MM-dd HH:mm:ss').format(localDateTime);
}
```

3. **更新初始化控制器**

```dart
_dateTimeValues['
userAccountExpireIn
'
]
=
tz.TZDateTime.from
(user.userAccountExpireIn, tz.local);
```

4. **更新日期选择器**

```dart
Future<void> _selectDateTime(String field) async {
  final tz.TZDateTime now = tz.TZDateTime.now(tz.local);
  final currentDate = _dateTimeValues[field] ?? now;

  // ...选择日期和时间...

  // 使用 tz.TZDateTime 创建本地时区的时间
  _dateTimeValues[field] = tz.TZDateTime(
    tz.local,
    pickedDate.year,
    pickedDate.month,
    pickedDate.day,
    pickedTime.hour,
    pickedTime.minute,
  );
}
```

5. **更新时间比较**

```dart
color: value.isBefore
(
tz.TZDateTime.now(tz.local))
?
Colors
.
red
:
Colors
.
green
,
```

#### 2.2 EditableUserOldServiceCardComponent

**文件**: `/lib/component/low_admin/editable_user_old_service_card_component.dart`

应用了与 `EditableUserV2InfoCardComponent` 相同的时区处理优化。

#### 2.3 UserOldServiceCardComponent

**文件**: `/lib/component/low_admin/user_old_service_card_component.dart`

只读显示组件，更新时间格式化和比较逻辑。

#### 2.4 UserV2InfoCardComponent

**文件**: `/lib/component/low_admin/user_v2_info_card_component.dart`

只读显示组件，更新时间格式化和比较逻辑。

#### 2.5 AuthStatusComponent

**文件**: `/lib/component/auth/auth_status_component.dart`

更新令牌过期时间计算逻辑。

### 3. 页面文件更新

#### 3.1 LowAdminUserBoughtListPage

**文件**: `/lib/page/low_admin/user_bought_list/low_admin_user_bought_list_page.dart`

更新购买记录的时间显示和过期状态判断。

#### 3.2 LowAdminUserBoughtRecordsPage

**文件**: `/lib/page/low_admin/user_bought_records/low_admin_user_bought_records_page.dart`

更新用户购买记录的时间显示、编辑和比较逻辑。

#### 3.3 LowAdminUserPayListPage

**文件**: `/lib/page/low_admin/user_pay_list/low_admin_user_pay_list_page.dart`

更新支付记录的创建时间和更新时间显示。

#### 3.4 LowAdminUserPayRecordsPage

**文件**: `/lib/page/low_admin/user_pay_records/low_admin_user_pay_records_page.dart`

更新用户支付记录的时间显示。

#### 3.5 LowAdminUsersListPage

**文件**: `/lib/page/low_admin/users_list/low_admin_users_list_page.dart`

更新用户列表的注册时间显示。

## 技术细节

### 全局时区设置流程

1. **应用启动** (`main.dart`)
   ```dart
   // 初始化时区数据库
   tz.initializeTimeZones();
   
   // 从 LocalTimeStore 读取用户设置的时区
   await LocalTimeStore().init();
   final String timeZoneName = LocalTimeStore().fixedTimeZone ?? 'Asia/Shanghai';
   
   // 设置全局时区
   tz.setLocalLocation(tz.getLocation(timeZoneName));
   ```

2. **用户自定义时区** (`system_local_time_page.dart`)
    - 用户可以在系统设置页面选择任意时区
    - 保存后立即生效，并持久化到 SharedPreferences
    - 下次启动应用时自动应用

3. **各组件使用**
    - 所有组件通过 `tz.TZDateTime.now(tz.local)` 获取当前本地时间
    - `tz.local` 引用的是 `main.dart` 中设置的全局时区

### 时区转换流程

#### 1. 从 API 获取数据（UTC → 本地时区）

```dart
// API 返回的是 UTC 时间
final apiDateTime = user.userAccountExpireIn; // UTC DateTime

// 转换为本地时区的 TZDateTime
final localTZDateTime = tz.TZDateTime.from(apiDateTime, tz.local);
```

#### 2. 用户选择时间（创建本地时区时间）

```dart

final tz.TZDateTime now = tz.TZDateTime.now(tz.local); // 获取当前本地时间

// 创建本地时区的新时间
final newDateTime = tz.TZDateTime(
  tz.local,
  year, month, day, hour, minute,
);
```

#### 3. 提交到 API（本地时区 → UTC）

```dart
// 提交前转换为 UTC（保持不变，仍使用 toUtc()）
userAccountExpireIn: (
data['userAccountExpireIn'] as DateTime).toUtc(
)
,
```

### 优势

1. **全局一致性**: 所有时间显示使用统一的时区设置
2. **用户可控**: 用户可以根据需要切换时区（如出差、多地办公）
3. **时区精确性**: `tz.TZDateTime` 包含完整的时区信息，比简单的 `DateTime.toLocal()` 更准确
4. **DST 处理**: 自动处理夏令时（Daylight Saving Time）转换
5. **可维护性**: 统一的时区处理方式，便于后续维护

## 测试建议

1. 验证默认时区为 `Asia/Shanghai` (UTC+08:00)
2. 测试在系统设置页面切换时区后，所有页面时间显示是否正确
3. 验证用户账户过期时间、等级过期时间显示是否正确
4. 测试时间选择器选择的时间是否正确保存和显示
5. 验证过期状态（红色/绿色）判断是否准确
6. 测试跨时区场景（切换到 UTC、美国东部时间等）
7. 重启应用，验证时区设置是否持久化

## 兼容性

- ✅ 向后兼容：API 仍然接收和返回 UTC 时间
- ✅ 数据格式不变：仍使用 `DateTime` 类型存储
- ✅ 显示优化：仅在 UI 层使用 `tz.TZDateTime` 进行更精确的时区处理
- ✅ 全局设置：所有页面自动使用统一的时区配置

## 相关文档

- [Flutter DateTime 时间处理规范](/.github/copilot-instructions.md#datetime-时间处理规范)
- [timezone package](https://pub.dev/packages/timezone)
- [系统设置 - 本地时区](/system/settings/local-time)

