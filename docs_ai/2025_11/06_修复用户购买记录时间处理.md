# 修复用户购买记录时间处理

**日期**: 2025-11-06  
**操作**: 修复用户购买记录页面的时间导入和导出处理

## 问题分析

### 原始问题

用户购买记录页面在处理时间时存在以下问题：

1. **显示时间错误**：直接显示 API 返回的 UTC 时间，未转换为本地时间
2. **编辑初始化错误**：使用 UTC 时间初始化时间选择器，导致显示时区不正确
3. **提交数据错误**：提交时未将本地时间转换为 UTC 时间

### 时间处理原则

根据项目 DateTime 处理规范：

- **API 使用 UTC 时间**：所有 API 接口收发的时间均为 UTC 格式
- **UI 显示本地时间**：用户界面显示和编辑使用本地时间
- **转换规则**：
    - 导入：API (UTC) → `.toLocal()` → UI (本地时间)
    - 导出：UI (本地时间) → `.toUtc()` → API (UTC)

## 修复内容

### 1. 修复时间显示

**位置**: `_buildBoughtCard()` 方法

**修改前**:

```dart

final isExpired =
    record.expireAt != null && record.expireAt!.isBefore(DateTime.now());

// ...显示时间
dateFormat.format
(
record.createdAt)
dateFormat.format(record.expireAt!
)
```

**修改后**:

```dart
// 将 UTC 时间转换为本地时间进行比较和显示
final localExpireAt = record.expireAt?.toLocal();
final isExpired =
    localExpireAt != null && localExpireAt.isBefore(DateTime.now());

// ...显示时间
dateFormat.format
(
record.createdAt.toLocal())
dateFormat.format(
localExpireAt
)
```

**说明**:

- 使用 `.toLocal()` 将 API 返回的 UTC 时间转换为本地时间
- 过期时间比较使用本地时间，确保时区正确
- 显示时间时统一转换为本地时间

### 2. 修复编辑初始化

**位置**: `_EditBoughtRecordDialogState.initState()`

**修改前**:

```dart
_createdAt = widget.record.createdAt; // 直接使用 UTC 时间
```

**修改后**:

```dart
// API 返回的是 UTC 时间，转换为本地时间供编辑使用
_createdAt = widget.record.createdAt.toLocal
();
```

**说明**:

- 初始化编辑器时使用本地时间
- 时间选择器显示和操作都基于本地时间
- 用户看到的是正确的本地时间，而不是 UTC 时间

### 3. 修复提交更新

**位置**: `_editBoughtRecord()` 方法

**修改前**:

```dart

final body = PutParamsModel(
  shopId: result['shopId'] as int,
  createdAt: result['createdAt'] as DateTime, // 直接使用本地时间
  moneyAmount: result['moneyAmount'],
);
```

**修改后**:

```dart
// 提交前必须转换为 UTC 时间
final body = PutParamsModel(
  shopId: result['shopId'] as int,
  createdAt: (result['createdAt'] as DateTime).toUtc(),
  moneyAmount: result['moneyAmount'],
);
```

**说明**:

- 从编辑器获取的是本地时间
- 提交给 API 前必须转换为 UTC 时间
- 使用 `.toUtc()` 方法确保时区正确

## 时间处理流程

### 数据流向

```
API 响应（UTC）
    ↓
DateTime.parse() 自动解析为 UTC
    ↓
.toLocal() 转换为本地时间
    ↓
UI 显示 / 编辑器初始化
    ↓
用户编辑（本地时间）
    ↓
.toUtc() 转换为 UTC 时间
    ↓
toIso8601String() 序列化为 UTC 字符串
    ↓
API 请求（UTC）
```

### 代码示例

#### 1. API 模型自动处理

```dart
// fromJson - 自动解析为 UTC
createdAt: DateTime.parse
(
json['created_at'] as String)

// toJson - 自动序列化为 UTC
'created_at'
:
instance
.
createdAt
.
toIso8601String
(
)
```

#### 2. UI 显示转换

```dart
// 显示时转换为本地时间
dateFormat.format
(
record
.
createdAt
.
toLocal
(
)
)
```

#### 3. 编辑初始化

```dart
// 初始化时转换为本地时间
_createdAt = widget.record.createdAt.toLocal
();
```

#### 4. 提交更新

```dart
// 提交时转换为 UTC
createdAt: (
result['createdAt'] as DateTime).toUtc(
)
```

## 验证结果

- ✅ Flutter analyze: 无错误
- ✅ 时间显示正确（本地时间）
- ✅ 过期状态判断正确（基于本地时间）
- ✅ 编辑器初始化正确（显示本地时间）
- ✅ 提交更新正确（转换为 UTC）

## 影响范围

**修改文件**:

- `/lib/pages/low_admin/user_bought_records.dart`

**修改方法**:

- `_buildBoughtCard()` - 显示时间转换
- `_EditBoughtRecordDialogState.initState()` - 初始化转换
- `_editBoughtRecord()` - 提交转换

## 最佳实践总结

### ✅ 正确做法

1. API 返回的 DateTime 是 UTC 时间
2. 显示前使用 `.toLocal()` 转换
3. 编辑器初始化使用本地时间
4. 提交前使用 `.toUtc()` 转换
5. 时间比较使用本地时间（`DateTime.now()` 自动返回本地时间）

### ❌ 错误做法

1. 直接显示 UTC 时间
2. 编辑器使用 UTC 时间初始化
3. 提交时不转换时区
4. 混用 UTC 和本地时间进行比较

## 相关文档

参考 `.github/copilot-instructions.md` 中的 "DateTime 时间处理规范" 章节，了解完整的时间处理指南。

