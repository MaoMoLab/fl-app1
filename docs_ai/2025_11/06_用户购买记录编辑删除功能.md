# 用户购买记录编辑删除功能

**日期**: 2025-11-06  
**操作**: 添加用户购买记录查看、编辑和删除功能

## 功能概述

为用户详情页面（user_v2.dart）添加了一个跳转按钮，可以查看该用户的购买记录，并支持对购买记录进行编辑和删除操作。

## 修改文件

### 1. `/lib/pages/low_admin/user_v2.dart`

**修改内容**:

- 添加了导入 `user_bought_records.dart`
- 在用户详情页面添加了"购买记录"卡片按钮
- 实现了 `_navigateToBoughtRecords()` 方法，用于导航到购买记录页面

**关键代码**:

```dart
Card
(
child: ListTile(
leading: Icon(
Icons.shopping_bag,
color: Theme.of(context).colorScheme.primary,
),
title: const Text('购买记录'),
subtitle: const Text('查看和管理用户的购买记录'),
trailing: const Icon(Icons.arrow_forward_ios, size: 16),
onTap
:
_navigateToBoughtRecords
,
)
,
)
```

### 2. `/lib/pages/low_admin/user_bought_records.dart` (新建)

**功能描述**:
这是一个全新的页面，用于显示特定用户的购买记录列表，并提供编辑和删除功能。

**主要特性**:

#### 数据加载

- 使用 `getUserBoughtApiV2LowAdminApiUserBoughtGet()` API 获取用户的购买记录
- 根据 `userId` 参数过滤特定用户的记录
- 支持下拉刷新功能

#### 显示信息

每条购买记录卡片显示以下信息：

- 商品名称 (shopName)
- 订单ID (id)
- 用户ID (userId)
- 商品ID (shopId)
- 金额 (moneyAmount)
- 购买时间 (createdAt)
- 过期时间 (expireAt，如果有）
- 过期状态标识（已过期/有效）

#### 编辑功能

- 点击"编辑"按钮打开编辑对话框
- 可编辑字段：
    - 商品ID (shopId)
    - 金额 (moneyAmount)
    - 购买时间 (createdAt)
- 使用 `putUserBoughtApiV2LowAdminApiUserBoughtBoughtIdPut()` API 更新记录
- 使用 `PutParamsModel` 作为请求体，符合项目规范

#### 删除功能

- 点击"删除"按钮弹出确认对话框
- 确认后使用 `deleteUserBoughtApiV2LowAdminApiUserBoughtBoughtIdDelete()` API 删除记录
- 删除成功后自动刷新列表

#### 编辑对话框 (`_EditBoughtRecordDialog`)

- 商品ID输入框（数字键盘）
- 金额输入框（带小数点的数字键盘）
- 购买时间选择器（日期+时间）
- 包含警告提示：修改购买记录可能影响用户的服务状态

## API 使用

### 查询购买记录

```dart

final result = await
_restClient.fallback
    .getUserBoughtApiV2LowAdminApiUserBoughtGet
(
limit: 3000,
userId: widget.userId,
);
```

### 删除购买记录

```dart

final result = await
_restClient.fallback
    .deleteUserBoughtApiV2LowAdminApiUserBoughtBoughtIdDelete
(
boughtId
:
boughtIdInt
,
);
```

### 更新购买记录

```dart

final body = PutParamsModel(
  shopId: result['shopId'] as int,
  createdAt: result['createdAt'] as DateTime,
  moneyAmount: result['moneyAmount'],
);

final response = await
_restClient.fallback
    .putUserBoughtApiV2LowAdminApiUserBoughtBoughtIdPut
(
boughtId
:
boughtIdInt
,
body
:
body
,
);
```

## 使用的数据模型

- `WebSubFastapiRoutersApiVLowAdminApiUserBoughtGetUserBoughtResponseResultListData` - 购买记录列表项
- `GetUserBoughtResponse` - 获取购买记录响应
- `PutParamsModel` - 更新购买记录请求参数
- `ErrorResponse` - 错误响应

## 导航流程

```
用户详情页面 (user_v2.dart)
    ↓ 点击"购买记录"按钮
    ↓ Navigator.push
用户购买记录页面 (user_bought_records.dart)
    ↓ 点击"编辑"按钮
    ↓ showDialog
编辑购买记录对话框 (_EditBoughtRecordDialog)
```

## 权限要求

所有操作都需要访问 `/api/v2/low_admin_api` 路径，必须携带有效的访问令牌，否则会返回 401 错误。

## 用户体验优化

1. **加载状态**: 显示加载指示器和提示文字
2. **错误处理**: 显示友好的错误消息和重试按钮
3. **空状态**: 当没有购买记录时显示空状态图标和提示
4. **确认对话框**: 删除操作需要用户确认，防止误操作
5. **即时反馈**: 操作成功/失败后显示 SnackBar 提示
6. **自动刷新**: 编辑或删除成功后自动刷新列表
7. **视觉标识**: 已过期的记录显示红色标签，有效记录显示绿色标签
8. **下拉刷新**: 支持手势下拉刷新数据

## 代码规范遵循

✅ 不使用无意义的 try-catch 包装  
✅ 使用最精简的方法实现功能  
✅ 不修改 /lib/api 下的自动生成代码  
✅ 使用 Model 参数调用 API，避免手动构造 query string  
✅ 正确处理需要访问令牌的 API 路径  
✅ 使用 createAuthenticatedClient() 创建认证客户端

## 测试建议

1. 测试有购买记录的用户
2. 测试没有购买记录的用户
3. 测试编辑功能（修改商品ID、金额、购买时间）
4. 测试删除功能（确认和取消）
5. 测试网络错误情况
6. 测试权限不足情况（401错误）
7. 测试下拉刷新功能
8. 测试过期记录的显示状态

