# 令牌失效自动跳转登录页

## 日期

2025年11月5日

## 问题描述

当用户的访问令牌和刷新令牌都失效时，应用会出现以下问题：

1. 不断重复尝试刷新令牌，导致大量 401 错误日志
2. 抛出未处理的 DioException 异常
3. 用户无法正常使用应用，也没有被引导到登录页面
4. 缺少友好的错误提示

## 解决方案

### 1. 添加导航回调到 AuthStore

在 `lib/utils/auth/auth_store.dart` 中添加了 `onNavigateToLogin` 回调函数，用于在令牌失效时触发页面跳转。

```dart
// 跳转到登录页回调，由外部设置
void Function()? onNavigateToLogin;

void _navigateToLogin() {
  if (onNavigateToLogin != null) {
    debugPrint('🔄 触发跳转到登录页');
    onNavigateToLogin!();
  } else {
    debugPrint('⚠️ 无法跳转到登录页（回调未设置）');
  }
}
```

### 2. 在 main.dart 中设置导航回调

在应用启动时配置回调函数，当令牌失效时自动跳转到登录页：

```dart
// 设置跳转到登录页回调
AuthStore
().onNavigateToLogin = () {router.go
('/login
'
);
};
```

### 3. 更新令牌刷新逻辑

在 `apiRefreshToken()` 方法中，当刷新失败时调用导航回调：

- 当没有刷新令牌时，清除令牌并跳转登录页
- 当刷新令牌返回 401/403 错误时，清除令牌并跳转登录页
- 当网络错误时，清除令牌并跳转登录页
- 其他未知错误时，清除令牌并跳转登录页

### 4. 优化错误处理

在 `lib/utils/auth/auth_interceptor.dart` 中改进了错误处理：

- 当令牌刷新失败时，不再抛出异常，而是返回一个包含错误信息的响应
- 添加了重试请求的错误处理，防止重试失败时的异常

```dart
return handler.resolve(
Response(
requestOptions: err.requestOptions,
statusCode: 401,
statusMessage: '认证失败，请重新登录',
data: {
'success': false,
'message': '认证失败，请重新登录',
},
)
,
);
```

### 5. 确保 Dashboard 页面的安全性

虽然 dashboard.dart 已经有 `if (!mounted) return;` 检查，但确保在异步操作完成后页面仍然存在才更新状态。

## 修改的文件

1. `/lib/utils/auth/auth_store.dart`
    - 添加 `onNavigateToLogin` 回调属性
    - 添加 `_navigateToLogin()` 私有方法
    - 在所有令牌刷新失败的情况下调用 `_navigateToLogin()`
    - 将 401 错误也纳入令牌失效处理逻辑

2. `/lib/utils/auth/auth_interceptor.dart`
    - 改进错误处理，令牌刷新失败时返回错误响应而不是抛出异常
    - 添加重试请求的错误处理

3. `/lib/main.dart`
    - 设置 `onNavigateToLogin` 回调，使用 `router.go('/login')` 跳转

4. `/lib/pages/user/dashboard.dart`
    - 保持现有的错误处理逻辑（已有 `!mounted` 检查）

## 用户体验改进

1. **自动跳转**：令牌失效时自动跳转到登录页，无需手动操作
2. **友好提示**：显示红色的 SnackBar 提示用户"登录令牌已过期，请重新登录"
3. **避免异常**：不再抛出未处理的 DioException，应用保持稳定
4. **减少日志污染**：避免反复尝试刷新令牌，减少错误日志

## 测试建议

1. 模拟令牌过期场景：
    - 手动删除存储的令牌
    - 等待令牌自然过期

2. 验证跳转行为：
    - 确认自动跳转到登录页
    - 确认显示红色错误提示

3. 验证登录后恢复：
    - 重新登录后能正常访问受保护页面

4. 检查日志：
    - 不应该出现未处理的异常
    - 不应该无限循环请求

## 技术要点

### 回调函数模式

使用回调函数解耦认证逻辑和导航逻辑，使 AuthStore 不需要依赖 GoRouter。

### 响应式错误处理

将异常转换为正常的错误响应，使 API 调用方能够统一处理错误情况。

### 全局 Router 访问

在 main.dart 中通过闭包捕获 router 实例，使其能在回调中使用。

## 注意事项

1. 确保在应用启动时设置回调函数，否则令牌失效时无法跳转
2. 登录页面不应该需要认证，否则会造成死循环
3. 错误提示会显示 4 秒，给用户足够时间阅读

